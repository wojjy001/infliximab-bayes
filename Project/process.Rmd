---
title: 'Infliximab: Time-Weighted Bayesian Estimation'
author: "Jessica Wojciechowski"
date: "7 July 2016"
output: html_document
---

```{r setup,echo = TRUE,warning = FALSE}
# Set working directory
  project.dir <- "/Volumes/Prosecutor/PhD/InfliximabBayes/infliximab-bayes/Project/"
  n <- 12  # Number of seed individuals that were simulated
  nsim <- 200 # Number of simulations of seed individuals
  sim.output.dir <- paste0("SIM",nsim,"_IND",n)
  work.dir <- paste0(project.dir,sim.output.dir,"/")
  setwd(project.dir)
  
# Load package libraries
  library(ggplot2)  # Plotting
  library(grid)  # Plotting
  library(plyr)  # ddply function
  
# Custom ggplot2 theme
	theme_bw2 <- theme_set(theme_bw(base_size = 12))  
  
# Pre-specified functions
  CI95lo <- function(x) quantile(x,probs = 0.025)  # Calculate 2.5th percentile
  CI95hi <- function(x) quantile(x,probs = 0.975)  # Calculate 97.5th percentile
  
  # Summary function for calculating median and prediction intervals
    summary.function <- function(x) {
      median <- median(x)
      stat.95lo <- CI95lo(x)
      stat.95hi <- CI95hi(x)
      result <- c(median,stat.95lo,stat.95hi)
      names(result)[c(1,2,3)] <- c("median","stat.95lo","stat.95hi")
      result
    }
    
  # Calculate the number of individuals below the target trough concentration at day 546 
    below.target.546 <- function(x) {
      below.target.data <- subset(x,time == 546)
      below.target.data$BTT[below.target.data$IPRE < 3] <- 1
      below.target.data$BTT[below.target.data$IPRE >= 3] <- 0
      result <- data.frame(
                  BTT = sum(below.target.data$BTT),
                  n = length(below.target.data$BTT)
      )
      result
    }    
  
# Pre-specified objects
  trough.target <- 3  # Don't want to be below the trough
  trough.upper <- 5  # Don't want concentrations to be too high - waste of drug
  infusion.times <- c(0,14,42,98,154,210,266,322,378,434,490,546)
  scale.log10.labels <- c(0.01,0.1,1,10,100,1000)
  sample.time1 <- 98  # Sampling time at the end of interval 1
  sample.time2 <- 210  # Sampling time at the end of interval 2
  sample.time3 <- 378  # Sampling time at the end of interval 3
  sample.time4 <- 546  # Sampling time at the end of interval 4
  sample.times <- c(sample.time1,sample.time2,sample.time3,sample.time4)
```

## Time-Weighting

```{r,echo = FALSE,warning = FALSE}
# Plot relative contribution to Bayes OFV
  ERRPRO <- 0.419  # Model RUV standard deviation
  TIME.seq <- seq(from = 0,to = 546,by = 1)  # Time sequence
  
  NTimeWeight <- ERRPRO  # Posterior SD for no time-weighting
  Peck1005 <- ERRPRO*1.005^(546-TIME.seq)  # Posterior SD for time-weighting using Q = 1.005
  Peck101 <- ERRPRO*1.01^(546-TIME.seq)  # Posterior SD for time-weighting using Q = 1.01
  Peck1015 <- ERRPRO*1.015^(546-TIME.seq)
  
  NTimeWeight.rel <- ERRPRO/NTimeWeight
  Peck1005.rel <- ERRPRO/Peck1005
  Peck101.rel <- ERRPRO/Peck101
  Peck1015.rel <- ERRPRO/Peck1015
  
  plotobj <- NULL
  plotobj <- ggplot()
  plotobj <- plotobj + geom_line(aes(x = TIME.seq,y = NTimeWeight.rel))
  plotobj <- plotobj + geom_line(aes(x = TIME.seq,y = Peck1005.rel),colour = "red")
  plotobj <- plotobj + geom_line(aes(x = TIME.seq,y = Peck101.rel),colour = "blue")
  plotobj <- plotobj + geom_line(aes(x = TIME.seq,y = Peck1015.rel),colour = "darkgreen")
  plotobj <- plotobj + scale_x_continuous("\nTime (days) since most recent observation")
  plotobj <- plotobj + scale_y_continuous("Relative contribution to objective function value\n")
  plotobj
```

## Label Scenario

```{r,echo = TRUE,warning = FALSE}
# Source the results of label_simulation
  label.data <- read.csv(paste0(work.dir,"label_simulation.csv"))
  label.data <- label.data[label.data$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0

# Plot the median and 95% prediction intervals for individual predicted concentrations (IPRE) over time
  plotobj1 <- NULL
  plotobj1 <- ggplot(label.data)
  plotobj1 <- plotobj1 + stat_summary(aes(x = time,y = IPRE),geom = "line",fun.y = median,colour = "red")
  plotobj1 <- plotobj1 + stat_summary(aes(x = time,y = IPRE),geom = "ribbon",fun.ymin = "CI95lo",fun.ymax = "CI95hi",fill = "red",alpha = 0.3)
  plotobj1 <- plotobj1 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
  plotobj1 <- plotobj1 + scale_x_continuous("\nTime (days)",breaks = infusion.times)
  plotobj1 <- plotobj1 + scale_y_log10("Infliximab Concentration (mg/L)\n",breaks = scale.log10.labels,labels = scale.log10.labels)
  # plotobj1 <- plotobj1 + facet_wrap(~ID)  # Facet for seeds
  print(plotobj1)
```

For each individual, the time spent under the target trough concentration (3 mg/L) for the entire 546 day period was calculated.

```{r,echo = TRUE,warning = FALSE}
# Calculate the time spent under the target trough at the end of each sampling interval
  label.data.AUT <- label.data[label.data$time %in% sample.times,]
  label.AUT.summary <- ddply(label.data.AUT, .(time), function(label.data.AUT) summary.function(label.data.AUT$AUT))
  print(label.AUT.summary[label.AUT.summary$time == 546,])
```

Number of individuals below the target trough concentration at day 546:

```{r,echo = TRUE,warning = FALSE}
# Label data
  print(below.target.546(label.data))
```

## Clinical Scenario

```{r,echo = TRUE,warning = FALSE}
# Source the results of clinical_simulation
  clinical.data <- read.csv(paste0(work.dir,"clinical_simulation.csv"))
  clinical.data <- clinical.data[clinical.data$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0

# Plot the median and 95% prediction intervals for individual predicted concentrations (IPRE) over time
  plotobj2 <- NULL
  plotobj2 <- ggplot(clinical.data)
  plotobj2 <- plotobj2 + stat_summary(aes(x = time,y = IPRE),geom = "line",fun.y = median,colour = "blue")
  plotobj2 <- plotobj2 + stat_summary(aes(x = time,y = IPRE),geom = "ribbon",fun.ymin = "CI95lo",fun.ymax = "CI95hi",fill = "blue",alpha = 0.3)
  plotobj2 <- plotobj2 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
  plotobj2 <- plotobj2 + scale_x_continuous("\nTime (days)",breaks = infusion.times)
  plotobj2 <- plotobj2 + scale_y_log10("Infliximab Concentration (mg/L)\n",breaks = scale.log10.labels,labels = scale.log10.labels)
  # plotobj2 <- plotobj2 + facet_wrap(~ID)  # Facet for seeds
  print(plotobj2)
```

We can see a significant improvement in the proportion of people who are achieving constant concentrations above the target trough (median line is predominantly above the line in the clinical scenario compared to the label scenario).

Calculate time spent under the target trough:

```{r,echo = TRUE,warning = FALSE}
# Calculate the time spent under the target trough at the end of each sampling interval
  clinical.data.AUT <- clinical.data[clinical.data$time %in% sample.times,]
  clinical.AUT.summary <- ddply(clinical.data.AUT, .(time), function(clinical.data.AUT) summary.function(clinical.data.AUT$AUT))
  print(clinical.AUT.summary[clinical.AUT.summary$time == 546,])
```

The median time spent under the target trough at time = 546 days in the clinical scenario is half compared to the label scenario.

Number of individuals below the target trough concentration at day 546:

```{r,echo = TRUE,warning = FALSE}
# Clinical data
  print(below.target.546(clinical.data))
```

## Bayesian Estimation and Dose Optimisation Scenarios

### No Time-Weighting, All Covariate Information is available

All observations are weighted equally when maximising the posterior likelihood.  Covariate information at the time of sampling as available.

```{r,echo = TRUE,warning = FALSE}
# Source the results of bayes_simulation
  method1 <- "NTimeWeight"
  covariate1 <- "AllCov"
  bayes.method1 <- paste0(method1,covariate1)
  bayes.data1 <- read.csv(paste0(work.dir,"/",bayes.method1,"/",bayes.method1,"_optimise_bayes_simulation.csv"))
  bayes.data1 <- bayes.data1[bayes.data1$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0

# Plot the median and 95% prediction intervals for individual predicted concentrations (IPRE) over time
  plotobj3 <- NULL
  plotobj3 <- ggplot()
  plotobj3 <- plotobj3 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1,geom = "line",fun.y = median,colour = "darkgreen")
  plotobj3 <- plotobj3 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1,geom = "ribbon",fun.ymin = "CI95lo",fun.ymax = "CI95hi",fill = "darkgreen",alpha = 0.3)
  plotobj3 <- plotobj3 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
  plotobj3 <- plotobj3 + scale_x_continuous("\nTime (days)",breaks = infusion.times)
  plotobj3 <- plotobj3 + scale_y_log10("Infliximab Concentration (mg/L)\n",breaks = scale.log10.labels,labels = scale.log10.labels)
  print(plotobj3)
```

Calculate time spent under the target trough:

```{r,echo = TRUE,warning = FALSE}
# Calculate the time spent under the target trough at the end of each sampling interval
  bayes.data.AUT1 <- bayes.data1[bayes.data1$time == 546,]
  bayes.AUT.summary1 <- ddply(bayes.data.AUT1, .(time), function(bayes.data.AUT1) summary.function(bayes.data.AUT1$AUT))
  print(bayes.AUT.summary1)
```

## No Time-Weighting versus Time-Weight (Peck, Q = 1.005 and 1.01), All Covariate Information Available

### Number of people below target trough concentration

```{r,echo = TRUE,warning = FALSE}
# Source the results of bayes_simulation
  method2 <- "Peck1.005"
  covariate2 <- "AllCov"
  bayes.method2 <- paste0(method2,covariate2)
  bayes.data2 <- read.csv(paste0(work.dir,"/",bayes.method2,"/",bayes.method2,"_optimise_bayes_simulation.csv"))
  bayes.data2 <- bayes.data2[bayes.data2$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0
  bayes.data.AUT2 <- bayes.data2[bayes.data2$time == 546,]

# Source the results of bayes_simulation
  method3 <- "Peck1.01"
  covariate3 <- "AllCov"
  bayes.method3 <- paste0(method3,covariate3)
  bayes.data3 <- read.csv(paste0(work.dir,"/",bayes.method3,"/",bayes.method3,"_optimise_bayes_simulation.csv"))
  bayes.data3 <- bayes.data3[bayes.data3$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0
  bayes.data.AUT3 <- bayes.data3[bayes.data3$time == 546,]  

  # Bayes data - no time-weighting 
  print(below.target.546(bayes.data1))
# Bayes data - Peck, 1.005 
  print(below.target.546(bayes.data2))
# Bayes data - Peck, 1.01 
  print(below.target.546(bayes.data3))
```  

### Time under target trough concentration

```{r,echo = TRUE,warning = FALSE}
# Assign some labels and combine the data frames 
  label.data.AUT$SCEN <- 1  # Label data
  clinical.data.AUT$SCEN <- 2 # Clinical data
  bayes.data.AUT1$SCEN <- 3 # Bayes data - no time-weighting
  bayes.data.AUT2$SCEN <- 4 # Bayes data - Peck, 1.005 
  bayes.data.AUT3$SCEN <- 5 # Bayes data - Peck, 1.01
  AUT.data1 <- rbind(label.data.AUT,clinical.data.AUT[,-5],bayes.data.AUT1[,-5],bayes.data.AUT2[,-5],bayes.data.AUT3[,-5])
  
# Plot
  plotobj6 <- NULL
  plotobj6 <- ggplot(AUT.data1[AUT.data1$time == 546,])
  plotobj6 <- plotobj6 + geom_boxplot(aes(x = SCEN,y = AUT,group = SCEN),outlier.shape = NA)
  plotobj6 <- plotobj6 + scale_y_continuous("Time under target trough (days)\n",lim = c(NA,NA))
  plotobj6 <- plotobj6 + scale_x_continuous("\nBayesian-Guided Dosing Study")
  print(plotobj6)
```

### Summary of amount of drug used in scenarios

```{r,echo = TRUE,warning = FALSE}
# Label data
  label.data.amt <- ddply(label.data, .(SIM,ID), function(label.data) sum(label.data$amt))
  print(summary.function(label.data.amt$V1))
# Clinical data
  clinical.data.amt <- ddply(clinical.data, .(SIM,ID), function(clinical.data) sum(clinical.data$amt))
  print(summary.function(clinical.data.amt$V1))  
# Bayes data - no time-weighting
  bayes.data.amt1 <- ddply(bayes.data1, .(SIM,ID), function(bayes.data1) sum(bayes.data1$amt))
  print(summary.function(bayes.data.amt1$V1))
# Bayes data - Peck 1.005
  bayes.data.amt2 <- ddply(bayes.data2, .(SIM,ID), function(bayes.data2) sum(bayes.data2$amt))
  print(summary.function(bayes.data.amt2$V1))
# Bayes data - Peck 1.01
  bayes.data.amt3 <- ddply(bayes.data3, .(SIM,ID), function(bayes.data3) sum(bayes.data3$amt))
  print(summary.function(bayes.data.amt3$V1))
```

## Explore Seed Individuals

### All Covariates

```{r,echo = TRUE,warning = FALSE}
# Time spent below target trough concentration
  plotobj7 <- NULL
  plotobj7 <- ggplot()
  plotobj7 <- plotobj7 + geom_boxplot(aes(x = ID,y = AUT,group = ID),data = bayes.data.AUT1,outlier.shape = NA,colour = "black",fill = NA)
  plotobj7 <- plotobj7 + geom_boxplot(aes(x = ID,y = AUT,group = ID),data = bayes.data.AUT2,outlier.shape = NA,colour = "blue",fill = NA)  
  # plotobj7 <- plotobj7 + geom_boxplot(aes(x = ID,y = AUT,group = ID),data = bayes.data.AUT3,outlier.shape = NA,colour = "red",fill = NA)  
  plotobj7 <- plotobj7 + scale_y_continuous("Time under target trough (days)\n",lim = c(NA,NA))
  plotobj7 <- plotobj7 + scale_x_continuous("\nSeed Individual ID",breaks = c(1:12))
  print(plotobj7)
```





