---
title: 'Infliximab: Time-Weighted Bayesian Estimation'
author: "Jessica Wojciechowski"
date: "7 July 2016"
output: 
  html_document: 
    fig_width: 10
    highlight: textmate
---

```{r,echo = TRUE,warning = FALSE}
# Remove all current objects in the workspace
	rm(list = ls(all = TRUE))
# Load package libraries
  library(ggplot2)  # Plotting
  library(grid)  # Plotting
  library(plyr)  # ddply function

# Custom ggplot2 theme
  theme_bw2 <- theme_set(theme_bw(base_size = 14))  
  
# Pre-specified functions
  CI95lo <- function(x) quantile(x,probs = 0.025)  # Calculate 2.5th percentile
  CI95hi <- function(x) quantile(x,probs = 0.975)  # Calculate 97.5th percentile
  
# Summary function for calculating median and prediction intervals
  summary.function <- function(x) {
    median <- median(x)
    stat.95lo <- quantile(x,probs = 0.025)
    stat.95hi <- quantile(x,probs = 0.975)
    result <- c(median,stat.95lo,stat.95hi)
    names(result)[c(1,2,3)] <- c("median","stat.95lo","stat.95hi")
    result
  }
  
# Set trough target objects
  trough.target <- 3
  trough.upper <- 5
  
# ------------------------------------------------------------------------------   
# Set working directory
  project.dir <- "/Volumes/Prosecutor/PhD/InfliximabBayes/Moved-Infliximab-Output/"
  
# Read in simulation output
  file.list <- list.files(path = project.dir,pattern = "SUCCESS") # List of successful simulation sets
  n <- 9  # Number of seed individuals that were simulated
  nsim <- 10  # Number of simulations of seed individuals per set
  nset <- length(file.list)  # Number of simulation sets in the directory
  set.seq <- 1:nset  # Sequence of "set" numbers

# Read in the label simulation data 
  read.label.data.function <- function(file.list) {
    label.data <- read.csv(file = paste0(project.dir,file.list,"/label_simulation.csv"))
  }
  label.data <- ldply(file.list,read.label.data.function,.progress = "text")
  SET <- sort(c(rep(set.seq,times = dim(label.data)[1]/nset)))
  label.data$SET <- SET
  label.data$STUDY <- 1
  
# Read in the clinical simulation data
  read.clinical.data.function <- function(file.list) {
    clinical.data <- read.csv(file = paste0(project.dir,file.list,"/clinical_simulation.csv"))
  }
  clinical.data <- ldply(file.list,read.clinical.data.function,.progress = "text")
  clinical.data$SET <- SET
  clinical.data$STUDY <- 2
  
# Read in the optimise.bayes simulation data
  read.optimise.bayes.data <- function(file.list) {
    optimise.bayes.data <- read.csv(file = paste0(project.dir,file.list,"/optimise_bayes_data.csv"))
  }
  optimise.bayes.data <- ldply(file.list,read.optimise.bayes.data,.progress = "text")
  optimise.bayes.data$SET <- SET
  optimise.bayes.data$STUDY <- 3
  
# Bind all data frames together
  all.data <- rbind(label.data,clinical.data,optimise.bayes.data)
  all.data <- all.data[all.data$time <= 546,] # Remove NA rows
  all.data$IPRE <- as.numeric(all.data$IPRE)
  all.data$STUDY <- as.factor(all.data$STUDY)
```

## Plot concentration-time for all studies

Represented as median and 95% prediction intervals

```{r,echo = TRUE,warning = FALSE}
# Line (median) and ribbon (prediction intervals)
  # Calculate
    summary.data <- ddply(all.data, .(STUDY,time), function(all.data) summary.function(all.data$IPRE))

  # Plot
    plotobj1 <- NULL
    plotobj1 <- ggplot(summary.data)
    plotobj1 <- plotobj1 + geom_line(aes(x = time,y = median,colour = STUDY))
    plotobj1 <- plotobj1 + geom_ribbon(aes(x = time,ymin = stat.95lo,ymax = stat.95hi,fill = STUDY),alpha = 0.3)
    plotobj1 <- plotobj1 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
    plotobj1 <- plotobj1 + geom_hline(aes(yintercept = trough.upper),linetype = "dashed")
    plotobj1 <- plotobj1 + scale_x_continuous("\nTime (days)")
    plotobj1 <- plotobj1 + scale_y_log10("Infliximab Concentration (mg/L)")
    plotobj1 <- plotobj1 + facet_wrap(~STUDY)
    plotobj1 <- plotobj1 + theme(legend.position = "none")
    print(plotobj1)
```

## Summarise TUT at time = 546 days for all studies

TUT = Time spent under the target trough concentration (3 mg/L)

```{r,echo = TRUE,warning = FALSE}
# Subset data frame for only time == 546
  all.data.546 <- all.data[all.data$time == 546,]
# Calculate median and percentiles for AUT at 546 for all studies
  summary.AUT.546 <- ddply(all.data.546, .(STUDY), function(all.data.546) summary.function(all.data.546$TUT))
  print(summary.AUT.546)
  
# Plot boxplots
  plotobj2 <- NULL
  plotobj2 <- ggplot(all.data.546)
  plotobj2 <- plotobj2 + geom_boxplot(aes(x = STUDY,y = TUT,group = STUDY),outlier.shape = NA)
  plotobj2 <- plotobj2 + scale_x_discrete("\nStudy")
  plotobj2 <- plotobj2 + scale_y_continuous("Time under target trough (days)\n")
  print(plotobj2)
```

## Proportion of individuals below target at time = 546 days

```{r,echo = TRUE,warning = FALSE}
# Use subsetted data for only time == 546 (all.data.546)
  all.data.546$BTT <- 0
  all.data.546$BTT[all.data.546$IPRE < trough.target] <- 1  # Below trough target (BTT) == 1 for IPRE < 3
  summary.BTT.546 <- ddply(all.data.546, .(STUDY), function(all.data.546) sum(all.data.546$BTT))
# Add further information to summary.BTT.546
  names(summary.BTT.546)[2] <- "nBTT"  # Number of individuals below trough target
  summary.BTT.546$n <- n*nsim*nset # Number of individuals in the study population
  summary.BTT.546$pBTT <- round(summary.BTT.546$nBTT/summary.BTT.546$n,digits = 3)  # Proportion of individuals BTT
  print(summary.BTT.546)
```

## Summary of findings
    
```{r,echo = TRUE,warning = FALSE}
# Set up folder to save the processed output
  save.dir <- "/Volumes/Prosecutor/PhD/InfliximabBayes/infliximab-bayes-plots/"
  sim.output.dir <- paste0("SIM",nsim,"_IND",n)
  dir.create(file.path(paste0(save.dir,sim.output.dir,"/")),showWarnings = FALSE)
```