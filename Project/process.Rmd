---
title: 'Infliximab: Time-Weighted Bayesian Estimation'
author: "Jessica Wojciechowski"
date: "7 July 2016"
output: pdf_document
---

```{r setup,echo = FALSE,warning = FALSE}
# Set working directory
  project.dir <- "/Volumes/Prosecutor/PhD/InfliximabBayes/infliximab-bayes/Project/"
  n <- 12  # Number of seed individuals that were simulated
  nsim <- 10 # Number of simulations of seed individuals
  sim.output.dir <- paste0("SIM",nsim,"_IND",n)
  work.dir <- paste0(project.dir,sim.output.dir,"/")
  setwd(project.dir)
  
# Load package libraries
  library(ggplot2)  # Plotting
  library(grid)  # Plotting
  library(plyr)  # ddply function
  
# Custom ggplot2 theme
	theme_bw2 <- theme_set(theme_bw(base_size = 14))  
  
# Pre-specified functions
  CI95lo <- function(x) quantile(x,probs = 0.025)  # Calculate 2.5th percentile
  CI95hi <- function(x) quantile(x,probs = 0.975)  # Calculate 97.5th percentile
  
  # Summary function for calculating median and prediction intervals
    summary.function <- function(x) {
      median <- median(x)
      stat.95lo <- CI95lo(x)
      stat.95hi <- CI95hi(x)
      result <- c(median,stat.95lo,stat.95hi)
      names(result)[c(1,2,3)] <- c("median","stat.95lo","stat.95hi")
      result
    }
  
# Pre-specified objects
  trough.target <- 3  # Don't want to be below the trough
  trough.upper <- 5  # Don't want concentrations to be too high - waste of drug
  infusion.times <- c(0,14,42,98,154,210,266,322,378,434,490,546)
  scale.log10.labels <- c(0.01,0.1,1,10,100,1000)
  sample.time1 <- 98  # Sampling time at the end of interval 1
  sample.time2 <- 210  # Sampling time at the end of interval 2
  sample.time3 <- 378  # Sampling time at the end of interval 3
  sample.time4 <- 546  # Sampling time at the end of interval 4
  sample.times <- c(sample.time1,sample.time2,sample.time3,sample.time4)
```

## Introduction: Time-Weighted Bayesian Estimation

### Infliximab Pharmacokinetic Model

## Population specifications

All patients weigh 70 kg.  All patients have a baseline albumin of 4 g/dL.

There are 12 seed individuals:

1. ADA onset = 154 days, final albumin = 3 g/dL
2. ADA onset = 154 days, final albumin = 4 g/dL
3. ADA onset = 154 days, final albumin = 5 g/dL
4. ADA onset = 294 days, final albumin = 3 g/dL
5. ADA onset = 294 days, final albumin = 4 g/dL
6. ADA onset = 294 days, final albumin = 5 g/dL
7. ADA onset = 462 days, final albumin = 3 g/dL
8. ADA onset = 462 days, final albumin = 4 g/dL
9. ADA onset = 462 days, final albumin = 5 g/dL
10. ADA onset = 646 days, final albumin = 3 g/dL
11. ADA onset = 646 days, final albumin = 4 g/dL
12. ADA onset = 646 days, final albumin = 5 g/dL

Between time = 0 (baseline) and time = 546 (final), patient albumin changes in a linear sine wave fashion (amplitude = 0.1, frequency = 60 days, phase = 0)

Random effect values for V1, Q and V2 change linearly between time = 0 and time = 546.  CL random effect does not change as this parameter holds ADA and albumin covariate effects.

## Dosing and Sampling Specifications

1. Simulations run from time = 0 to time = 546 days (approximately 18 months)
2. There are 4 sampling intervals:
    + Sampling interval 1; 0 to 98 days
    + Sampling interval 2; 98 to 210 days
    + Sampling interval 3; 210 to 378 days
    + Sampling interval 4; 378 to 546 days
3. Trough concentrations are sampled at the end of each sampling interval, i.e., time = 98, 210, 378 and 546 days since first dose
4. There are 2 or 3 2-hour infliximab infusions administered in each sampling interval
    + Sampling interval 1; 0, 14 and 42 days
    + Sampling interval 2; 98 and 154 days
    + Sampling interval 3; 210, 266 and 322 days
    + Sampling interval 4; 378, 434 and 490 days

## Label Scenario

Every patient receives a 5 mg/kg dose of infliximab at every infusion time (i.e., 350 mg infused over 2 hours)

```{r Label Scenario Plot Output,echo = FALSE,warning = FALSE}
# Source the results of label_simulation
  label.data <- read.csv(paste0(work.dir,"label_simulation.csv"))
  label.data <- label.data[label.data$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0

# Plot the median and 95% prediction intervals for individual predicted concentrations (IPRE) over time
  plotobj1 <- NULL
  plotobj1 <- ggplot(label.data)
  plotobj1 <- plotobj1 + stat_summary(aes(x = time,y = IPRE),geom = "line",fun.y = median,colour = "red")
  plotobj1 <- plotobj1 + stat_summary(aes(x = time,y = IPRE),geom = "ribbon",fun.ymin = "CI95lo",fun.ymax = "CI95hi",fill = "red",alpha = 0.3)
  plotobj1 <- plotobj1 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
  plotobj1 <- plotobj1 + scale_x_continuous("\nTime (days)",breaks = infusion.times)
  plotobj1 <- plotobj1 + scale_y_log10("Infliximab Concentration (mg/L)\n",breaks = scale.log10.labels,labels = scale.log10.labels)
  print(plotobj1)
```

For each individual, the time spent under the target trough concentration (3 mg/L) for the entire 546 day period was calculated.

```{r Label Scenario AUT Output,echo = FALSE,warning = FALSE}
# Calculate the time spent under the target trough at the end of each sampling interval
  label.data.AUT <- label.data[label.data$time %in% sample.times,]
  label.AUT.summary <- ddply(label.data.AUT, .(time), function(label.data.AUT) summary.function(label.data.AUT$AUT))
  print(label.AUT.summary)
```

## Clinical Scenario

Scenario where every patient receives a 5 mg/kg dose of infliximab for every infusion time in the first sampling interval (i.e., at 0, 14 and 42 days). Then:

* Trough concentration at time = 98 days is sampled (DV)
* Dose for the next sampling interval is determined as:
    + If a sample < trough target OR sample >= trough upper (5 mg/L) then the new dose will be equal to (trough target/sample)*previous dose
    + If a sample is within the pre-specified range, then the patient continues with the previous dose
* Cycle is repeated at sampling times = 210 and 378 days

```{r Clinical Scenario Plot Output,echo = FALSE,warning = FALSE}
# Source the results of clinical_simulation
  clinical.data <- read.csv(paste0(work.dir,"clinical_simulation.csv"))
  clinical.data <- clinical.data[clinical.data$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0

# Plot the median and 95% prediction intervals for individual predicted concentrations (IPRE) over time
  plotobj2 <- NULL
  plotobj2 <- ggplot(clinical.data)
  plotobj2 <- plotobj2 + stat_summary(aes(x = time,y = IPRE),geom = "line",fun.y = median,colour = "blue")
  plotobj2 <- plotobj2 + stat_summary(aes(x = time,y = IPRE),geom = "ribbon",fun.ymin = "CI95lo",fun.ymax = "CI95hi",fill = "blue",alpha = 0.3)
  plotobj2 <- plotobj2 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
  plotobj2 <- plotobj2 + scale_x_continuous("\nTime (days)",breaks = infusion.times)
  plotobj2 <- plotobj2 + scale_y_log10("Infliximab Concentration (mg/L)\n",breaks = scale.log10.labels,labels = scale.log10.labels)
  print(plotobj2)
```

We can see a significant improvement in the proportion of people who are achieving constant concentrations above the target trough (median line is predominantly above the line in the clinical scenario compared to the label scenario).

Calculate time spent under the target trough:

```{r Clinical Scenario AUT Output,echo = FALSE,warning = FALSE}
# Calculate the time spent under the target trough at the end of each sampling interval
  clinical.data.AUT <- clinical.data[clinical.data$time %in% sample.times,]
  clinical.AUT.summary <- ddply(clinical.data.AUT, .(time), function(clinical.data.AUT) summary.function(clinical.data.AUT$AUT))
  print(clinical.AUT.summary)
```

The median time spent under the target trough at time = 546 days in the clinical scenario is half compared to the label scenario.

Summarise the amount of drug administered over the 546 day period:

```{r Clinical Scenario AMT Output,echo = FALSE,warning = FALSE}
# Summarise the amount of drug administered over the 546 day period
  # Subset times that only had doses administered
    clinical.data.AMT <- clinical.data[clinical.data$amt != 0,]
  # For each individual calculate how much drug was administered to them over the entire time-period
    clinical.AMT.individual <- ddply(clinical.data.AMT, .(ID,SIM), function(clinical.data.AMT) sum(clinical.data.AMT$amt))
  # Summarise in median and 95% prediction intervals
    clinical.AMT.summary <- ddply(clinical.AMT.individual, .(), function(clinical.AMT.individual) summary.function(clinical.AMT.individual$V1))
    print(clinical.AMT.summary)
```

## Bayesian Estimation and Dose Optimisation Scenarios

Scenario where every patient receives a 5 mg/kg dose of infliximab for every infusion time in the first sampling interval (i.e., at 0, 14 and 42 days). Then:

* Trough concentration at time = 98 days is sampled (DV)
* Individual values for pharmacokinetic parameters are obtained from empirical Bayes estimates using known administered doses, the sample, and covariate information at time = 0 and the sampling time
* Doses for the next sampling interval are determined by maximum likelihood estimation (minimise the error between trough concentration given optimised doses and the target trough concentration)
    + Optimised doses for the next sampling interval are allowed to be different
    + Initial estimates for doses are obtained by using the method described earlier in "Clinical Scenario"
    + If an initial estimate for a dose was greater than 1,000,000 mg - then doses were not optimised for the patient and they were just administered 1,000,000 mg
* Cycle is repeated at sampling times = 210 and 378 days
    + Bayes estimates obtained from subsequent sampling intervals are based on all previous samples, not just the most recent one
* When simulating the next interval given the individual parameters estimated from the previous interval, covariate values from the last sample are carried forward
    + We can predict the concentrations, however we cannot predict changes in their covariate profile

### No Time-Weighting, All Covariate Information is available

All observations are weighted equally when maximising the posterior likelihood.  Covariate information at the time of sampling as available.

```{r Bayes Scenario 1 Plot Output,echo = FALSE,warning = FALSE}
# Source the results of bayes_simulation
  method1 <- "NTimeWeight"
  covariate1 <- "AllCov"
  bayes.method1 <- paste0(method1,covariate1)
  bayes.data1 <- read.csv(paste0(work.dir,"/",bayes.method1,"/",bayes.method1,"_optimise_bayes_simulation.csv"))
  bayes.data1 <- bayes.data1[bayes.data1$SIM != 0,]  # Ignore the population typical individual simulation, i.e., SIM == 0

# Plot the median and 95% prediction intervals for individual predicted concentrations (IPRE) over time
  plotobj3 <- NULL
  plotobj3 <- ggplot()
  plotobj3 <- plotobj3 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1,geom = "line",fun.y = median,colour = "darkgreen")
  plotobj3 <- plotobj3 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1,geom = "ribbon",fun.ymin = "CI95lo",fun.ymax = "CI95hi",fill = "darkgreen",alpha = 0.3)
  plotobj3 <- plotobj3 + geom_hline(aes(yintercept = trough.target),linetype = "dashed")
  plotobj3 <- plotobj3 + scale_x_continuous("\nTime (days)",breaks = infusion.times)
  plotobj3 <- plotobj3 + scale_y_log10("Infliximab Concentration (mg/L)\n",breaks = scale.log10.labels,labels = scale.log10.labels)
  print(plotobj3)
```

Calculate time spent under the target trough:

```{r Bayes Scenario 1 AUT Output,echo = FALSE,warning = FALSE}
# Calculate the time spent under the target trough at the end of each sampling interval
  bayes.data.AUT1 <- bayes.data1[bayes.data1$time %in% sample.times,]
  bayes.AUT.summary1 <- ddply(bayes.data.AUT1, .(time), function(bayes.data.AUT1) summary.function(bayes.data.AUT1$AUT))
  print(bayes.AUT.summary1)
```

Bayesian guided dosing does not appear to be better compared to the "Clinical Scenario" in terms of maintaining trough concentrations above the target.  However, is an improvement on current label recommendations.

Summarise the amount of drug administered over the 546 day period:

```{r Bayes Scenario 1 AMT Output,echo = FALSE,warning = FALSE}
# Summarise the amount of drug administered over the 546 day period
  # Subset times that only had doses administered
    bayes.data.AMT1 <- bayes.data1[bayes.data1$amt != 0,]
  # For each individual calculate how much drug was administered to them over the entire time-period
    bayes.AMT.individual1 <- ddply(bayes.data.AMT1, .(ID,SIM), function(bayes.data.AMT1) sum(bayes.data.AMT1$amt))
  # Summarise in median and 95% prediction intervals
    bayes.AMT.summary1 <- ddply(bayes.AMT.individual1, .(), function(bayes.AMT.individual1) summary.function(bayes.AMT.individual1$V1))
    print(bayes.AMT.summary1)
```

However, Bayesian guided dosing appears to use less drug than the "clinical scenario."

Compare "what happened in the patient given Bayes guided dosing" compared to what "Bayesian estimation" thought was going on.

```{r Bayes Scenario 1 Estimation Output,echo = FALSE,warning = FALSE}
# Read in Bayesian simulated data for each interval
  # Interval 1
    bayes.data1.interval1 <- read.csv(paste0(work.dir,"/",bayes.method1,"/",bayes.method1,"_interval2_bayes_sim.csv"),stringsAsFactors = FALSE,na.strings = ".")
    bayes.data1.interval1 <- bayes.data1.interval1[bayes.data1.interval1$SIM != 0,]
  # Interval 2
    bayes.data1.interval2 <- read.csv(paste0(work.dir,"/",bayes.method1,"/",bayes.method1,"_interval3_bayes_sim.csv"),stringsAsFactors = FALSE,na.strings = ".")
    bayes.data1.interval2 <- bayes.data1.interval2[bayes.data1.interval2$SIM != 0,]    
  # Interval 3
    bayes.data1.interval3 <- read.csv(paste0(work.dir,"/",bayes.method1,"/",bayes.method1,"_interval4_bayes_sim.csv"),stringsAsFactors = FALSE,na.strings = ".")
    bayes.data1.interval3 <- bayes.data1.interval3[bayes.data1.interval3$SIM != 0,]      
    
# Add to plotobj3
  plotobj4 <- NULL
  plotobj4 <- plotobj3
  # Interval 1,2,3 
    plotobj4 <- plotobj4 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1.interval3,geom = "line",fun.y = median,linetype = "dashed")
    plotobj4 <- plotobj4 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1.interval3,geom = "line",fun.y = "CI95lo",linetype = "dashed")
    plotobj4 <- plotobj4 + stat_summary(aes(x = time,y = IPRE),data = bayes.data1.interval3,geom = "line",fun.y = "CI95hi",linetype = "dashed")
  print(plotobj4)
```
